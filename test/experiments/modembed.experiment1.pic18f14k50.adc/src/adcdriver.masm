module adcdriver target microchip.pic18{
	
	instance microchip.pic18.pic18f14k50 cpu;
	
	/*
	 * ANSEL is missing from CPU config!
	 */
	 symbol ANSEL 0xf7E;
	
	/*
	 * Input pin is RA4
	 */
	 symbol TRISBIT 4;
	 symbol ANSELBIT 3;
	 symbol ADCHSEL 12;
	
	var resultH;
	var resultL;
	
	func init{
		MOVLB 0xf;
		// port selection
		BSF TRISBIT 0 cpu.TRISA;
		BSF ANSELBIT 0 ANSEL;
		// channel selection
		MOVLW ADCHSEL;
		MOVWF 0 cpu.ADCON0;
		// reference voltages are Vdd and Vss
		CLRF 0 cpu.ADCON1;
		// clock and aquisition time selection
		MOVLW 85;
		MOVWF 0 cpu.ADCON2;
		// turn on ADC
		BSF 0 0 cpu.ADCON0;
		MOVLB 0;
		RETURN 0;
	};
	
	func read{
		MOVLB 0xf;
		// start conversion
		BSF 1 0 cpu.ADCON0;
		label ADC_poll;
		BTFSC 1 0 cpu.ADCON0;
		BRA ADC_poll;
		MOVFF cpu.ADRESH resultH;
		MOVFF cpu.ADRESL resultL;
		MOVLB 0;
		RETURN 0;
	};
	
}